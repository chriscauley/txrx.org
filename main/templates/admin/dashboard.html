{% extends "base.html" %}
{% load compress %}

{% block main %}
<ur-plot></ur-plot>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script type="riot/tag">
  <h1>Sales Dashboard</h1>
  <ur-plot>
    <ur-form initial={ initial } action="/dashboard/totals.json" ajax_success={ update_plot }
             schema={ schema }></ur-form>
    <div id="tester" style="width:600px;height:250px;"></div>

    var self = this;
    this.schema = [
      { name: 'metric', type: 'select', required: false,
        choice_tuples: [
          ['line_total','Cart Total'],
          ['quantity','Quantity'],
          ['new_students','New Students'],
          ['classes_per_student','Classes Per Student'],
        ]
      },
      { name: 'product_types', type: 'hidden', required: false,
        choice_tuples: [
          ["",'All Products'],
          ["214","Course Enrollments"],
          ["215","Giftcards"],
          ["121","Shop Consumables"],
          //["133","Meberships"],
        ]
      },
      { name: 'time_period', type: 'select', required: false,
        choice_tuples: [
          [90,'Three Months'],
          [180,'Six Months'],
          [365,'One Year'],
        ]
      },
    ];
    this.initial = uR.getQueryDict();
    this.initial.time_period = this.initial.time_period || 90;
    this.initial.product_types = this.initial.product_types || 214;
    this.initial.metric = this.initial.metric || 'line_total';
    this.on("mount",function() {
      this.update();
      setTimeout(function() { document.querySelector("ur-form button").dispatchEvent(new Event("click"))},0)
    });
    update_plot(data) {
      var qs = "?";
      var form_data = self.tags["ur-form"].getData();
      for (key in form_data) { qs += key + "=" + encodeURIComponent(form_data[key]) + "&"; }
      window.history && window.history.replaceState({},"",window.location.pathname+qs);
      self.data = data;
      var TESTER = document.getElementById('tester');
      Plotly.purge(TESTER);
      var metric = document.querySelector("[name=metric]");
      Plotly.plot(
        TESTER, [
          { x: data.days, y: data.data, name: metric.options[metric.selectedIndex].innerText},
        ],
        {
          margin: { l: 50, r: 20, b: 40, t: 20 },
          xaxis: {
            title: 'Date',
          },
        }
      );
    }
  </ur-plot>

</script>
{% endblock %}

{% block extrajs %}
<script>
  uR.ready(uR.auth.loginRequired(function() { riot.mount("ur-plot"); }));
</script>
{% endblock %}
