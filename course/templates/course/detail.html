{% extends "base.html" %}
{% load mptt_comments_tags thumbnail %}
{% load short_codes %}

{% block title %}{{ course }}{% endblock %}
{% block header %}{% endblock %}

{% block fb_title %}{{ course }} at TXRX Labs{% endblock %}
{% block fb_description %}{{ course.description|implosivo|escape }}{% endblock %}

{% block main %}
<h1 class="page_title">
  {{ course }}
  <div class="fee"><script>document.write({{ member_discount }}*{{ course.fee }});</script></div>
</h1>
<div class="course-detail row">
  <div class="col-sm-4 col-md-5">
    <div class="details">
      <div class="subjects pull-right">
        <b>Subject{{ course.subjects.all|pluralize:"s" }}</b>:
        {{ course.subjects.all|join:", " }}
      </div>
      <div class="calendar_widget">
        <a href="javascript:;" onclick="$('.add_to_calendar').toggle()">
          <span class="glyphicon glyphicon-calendar"></span> Add to calendar</a>
        {% include "course/_add_to_calendar.html" with calendar_event=session calendar_context="classes" %}{#! this needs to be fixed #}
      </div>
      {% if course.branding %}
      {% thumbnail course.branding.image "620x100" as im %}
      <img src="{{ im.url }}" width="620" />
      {% endthumbnail %}
      {% endif %}
    </div>
    <div class="slide-wrapper">
      {% include "widgets/thing_slideshow.html" with thing=course %}
      <div class="fee"><script>document.write({{ member_discount }}*{{ course.fee }});</script></div>
    </div>
  </div>
  <div class="col-sm-4">
    <div class="description">
      {{ course.description|explosivo }}
    </div>
    {% if course.fee_notes %}
    <p class="notes"><b>* Fee Notes:</b> {{ course.fee_notes }}</p>
      {% endif %}
    {% if course.requirements %}
    <p class="notes"><b>Requirements:</b> {{ course.requirements }}</p>
    {% endif %}
    {% if course.prerequisites %}
    <p class="notes"><b>Prerequisites:</b> {{ course.prerequisites }}</p>
    {% endif %}
    {% if course.get_files %}
    <div>
      <h2>Relevant files</h2>
      {% for f in course.get_files %}
      <a href="{{ f.file.url }}" target="_blank">{{ f.name }}</a><br/>
      {% endfor %}
    </div>
    {% endif %}
    <h3>Can't make it to any of these sessions?</h3>
    <p class="notify_course">
      {% if notify_course %}
      <a href="{% url "clear_notification" "notify_course" request.user.id notify_course.id %}">
        <button class="btn btn-danger">
          Don't send me emails when this class is scheduled
        </button>
      </a>
      {% else %}
      <a href="{% url "notify_course" course.id %}"><button class="btn btn-success">
          Email me the next time this class is scheduled</button></a>
      {% endif %}
    </p>
    <div style="clear: both;"></div>
  </div>
  <div class="col-sm-4 col-md-3" id="side">
    {% if enrollment %}
    <div class="well">
      <h2>You are enrolled in this course</h2>
      {% for classtime in enrollment.session.classtime_set.all %}
      <h4>{{ classtime.start|date:"l F j g:i A"|safe }} - {{ classtime.end_time|time:"g:i A" }}</h4>
      {% endfor %}
    </div>
    {# {% include "course/_student_panel.html" %} #}
    {% else %}
    <div class="SessionList">
      <h3>
        {% if course.open_sessions %}
        {{ course.open_sessions|length }} upcoming session{{ course.open_sessions|pluralize }}:
        {% else %}
        There are no upcoming sessions.
        {% endif %}
      </h3>
      {% for session in course.open_sessions %}
      <div class="well session" id="s{{ session.id }}">
        <div class="dates">
          {% for classtime in session.classtime_set.all %}
          <h4>{{ classtime.start|date:"b j P"|title }} - {{ classtime.end|date:"P (D)"|title }}</h4>
          {% endfor %}
          with {{ session.user.username }}
        </div>
        {% if request.user == session.user %}
        <center>
          <a href="{% url "course:instructor_session" session.pk %}" class="btn btn-primary">
            View instructor page</a>
        </center>
        {% else %}
        {% include "course/_enroll_link.html" %}
        {% endif %}
      </div>
      {% endfor %}
      {% if course.full_sessions %}
      <h3>
        There are also {{ course.full_sessions|length }} full session{{ course.full_sessions|pluralize }}:
      </h3>
      {% endif %}
      {% for session in course.full_sessions %}
      <div class="well session" id="s{{ session.id }}">
        <div class="dates">
          {% for classtime in session.classtime_set.all %}
          <h4>{{ classtime.start|date:"l F j g:i A"|safe }} - {{ classtime.end_time|time:"g:i A" }}</h4>
          {% endfor %}
          with {{ session.user.username }}
        </div>
        {% if request.user == session.user %}
        <center>
          <a href="{% url "course:instructor_session" session.pk %}" class="btn btn-primary">
            View instructor page</a>
        </center>
        {% else %}
        {% include "course/_enroll_link.html" %}
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% endif %}
    <center>
      <span class="st_facebook_large" displayText="Facebook"></span>
      <span class="st_twitter_large" displayText="Tweet" st_via="TXRXLabs"></span>
      <span class="st_pinterest_large" displayText="Pinterest"></span>
      <span class="st_googleplus_large" displayText="Google +"></span>
      <span class="st_reddit_large" displayText="Reddit"></span>
    </center>
    {% if request.user.is_staff %}
    {% include "course/_instructor_panel.html" %}
    {% endif %}
  </div>
  <div class="col-xs-12">{% display_comment_toplevel_for course %}</div>
</div>
{% endblock %}
