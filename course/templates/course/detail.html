{% extends "base.html" %}
{% load mptt_comments_tags thumbnail %}
{% load short_codes txrx_tags %}

{% block title %}{{ course }}{% endblock %}
{% block header %}{% endblock %}

{% block fb_title %}{{ course }} at TXRX Labs{% endblock %}
{% block fb_description %}{{ course.description|implosivo|escape }}{% endblock %}

{% block main %}
<h1 class="page_title">
  {{ course }}
</h1>
<div class="course-detail row">
  {% if enrollment %}
  <div class="col-sm-4 col-md-3 col-xs-12 pull-right">
    <div class="well">
      <h2>You are enrolled in this course</h2>
      {% for classtime in enrollment.session.classtime_set.all %}
      <div>{{ classtime|format_classtime }}</div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
  <div class="col-sm-4 col-md-5">
    {% comment %}
    <div class="subjects pull-right">
      <b>Subject{{ course.subjects.all|pluralize:"s" }}</b>:
      {{ course.subjects.all|join:", " }}
    </div>
    {% endcomment %}
    {% if course.branding %}
    {% thumbnail course.branding.image "620x100" as im %}
    <img src="{{ im.url }}" width="620" />
    {% endthumbnail %}
    {% endif %}
    <div class="slide-wrapper">
      {% include "widgets/thing_slideshow.html" with thing=course %}
    </div>
    {% comment %}
    <div class="calendar_widget">
      <a href="javascript:;" onclick="$('.add_to_calendar').toggle()">
        <span class="glyphicon glyphicon-calendar"></span> Add to calendar</a>
      {% include "course/_add_to_calendar.html" with calendar_event=session calendar_context="classes" %}{#! this needs to be fixed #}
    </div>
    {% endcomment %}
  </div>
  <div class="col-sm-4">
    <div class="description">
      {{ course.description|explosivo }}
    </div>
    {% if course.fee_notes %}
    <p class="notes"><b>* Fee Notes:</b> {{ course.fee_notes }}</p>
      {% endif %}
    {% if course.requirements %}
    <p class="notes"><b>Requirements:</b> {{ course.requirements }}</p>
    {% endif %}
    {% if course.prerequisites %}
    <p class="notes"><b>Prerequisites:</b> {{ course.prerequisites }}</p>
    {% endif %}
    {% if course.get_files %}
    <div>
      <h2>Relevant files</h2>
      {% for f in course.get_files %}
      <a href="{{ f.file.url }}" target="_blank">{{ f.name }}</a><br/>
      {% endfor %}
    </div>
    {% endif %}
    <h3>Can't make it to any of these sessions?</h3>
    <p class="notify_course">
      {% if notify_course %}
      <a href="{% url "clear_notification" "notify_course" request.user.id notify_course.id %}">
        <button class="btn btn-danger">
          Don't send me emails when this class is scheduled
        </button>
      </a>
      {% else %}
      <a href="{% url "notify_course" course.id %}"><button class="btn btn-success">
          Email me the next time this class is scheduled</button></a>
      {% endif %}
    </p>
    <div style="clear: both;"></div>
  </div>
  <div class="col-xs-12 col-sm-4 col-md-3 pull-right" id="side">
    {% if enrollment %}
    {# {% include "course/_student_panel.html" %} #}
    {% else %}
    <div class="SessionList">
      <h1 class="fee page_title">
        {% if course.fee %}
        $<script>document.write(Math.round({{ member_discount }}*{{ course.fee }},2));</script>
        {% else %}
        Free
        {% endif %}
      </h1>
      {% for session in course.active_sessions %}
      {% if not session.full %}
      <input type="radio" name="session_id" {% ifchanged 1 %} checked="checked"{% endifchanged %}
             id="id_session_{{ session.id }}" value="{{ session.id }}" />
      {% endif %}
      <label class="well session" for="id_session_{{ session.id }}">
        {% if not session.full %}
        {#<i class="fa fa-check"></i> #}
        <i class="fa fa-circle-o"></i>
        <i class="fa fa-dot-circle-o"></i>
        {% endif %}
        <div class="dates">
          {% if session.full %}
          <b class="full">This session is full</b>
          {% else %}
          with {{ session.user.username }}
          {% endif %}
          {% for classtime in session.classtime_set.all %}
          <div>{{ classtime|format_classtime }}</div>
          {% endfor %}
        </div>
      </label>
      <script>
      window.SESSIONS_ON_PAGE = window.SESSIONS_ON_PAGE || {};
        window.SESSIONS_ON_PAGE[{{ session.id }}] = {
        'name': "<b>{{ session.course }}</b> {{ session.first_date|date:"m/d/Y" }}",
        'fee': {{ member_discount }}*{{ session.course.fee }},
        };
      </script>
      {% endfor %}
      {% if course.open_sessions %}
      <div class="EnrollLink">
        <button class="btn btn-primary add" onclick="addClass();">
          {% if session.in_progress %}In Progress{% else %}Enroll{% endif %}</button>
        <button class="btn btn-primary btn-cart drop" data-toggle="modal" data-target="#cartModal">
          <i class="fa fa-shopping-cart"></i>
          View Cart
        </button>
      </div>
      <div class="error alert alert-danger">
        Please choose a session above and click enroll to add the session to your cart
      </div>
      {% endif %}
    </div>
    {% endif %}
    <center>
      <span class="st_facebook_large" displayText="Facebook"></span>
      <span class="st_twitter_large" displayText="Tweet" st_via="TXRXLabs"></span>
      <span class="st_pinterest_large" displayText="Pinterest"></span>
      <span class="st_googleplus_large" displayText="Google +"></span>
      <span class="st_reddit_large" displayText="Reddit"></span>
    </center>
    {% if request.user.is_staff %}
    {# {% include "course/_instructor_panel.html" %} #}
    {% endif %}
  </div>
  <div class="col-xs-12 col-sm-8 col-md-9">{% display_comment_toplevel_for course %}</div>
</div>
{% endblock %}
