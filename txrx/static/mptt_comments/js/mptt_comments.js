var replies_loaded = [];

function is_in(list, item) {
    for (var i = 0; i < list.length; i++) {
        if (list[i] == item) {
            return true;
        }
    }
    return false;
}

jQuery(document).ready(function($) {
    function update_replies_count(nxt) {
        var parents = nxt.parents('.comment');

        parents.each(function() {
            var item = $("#c-reply-counts-" + this.id + " .comment_replies");
            if (item.length > 0) {
                var count = parseInt(item.data('commentscount'), 10) + 1;
                item.data('commentscount', count);
                var d = {
                    count: count
                };
                item.text(interpolate(ngettext('%(count)s reply', '%(count)s replies', d.count), d, true));
            }
        });
    }

    function append_data_and_rebind_form(node, data) {
        node.empty();
        node.append(data);
        node.slideDown("slow");

        var form = $("form", node);
        bind_submit(form, node);
    }
    
    function ajax_error(nxt, data, textStatus) {    
        var status = data.status;
        data = data.responseText;
        // User is not logged in or some other error.
        // If it's a 403, we assume the HTML content is safe and 
        // was generated by our ajax_login_required decorator, so
        // we can re-use it.
        // If not, just use a standard error message.
        
        if (status != 403 || data === "") {
            data = gettext('An unexpected error occured. Please try again in a few minutes');
        }
        var form = $('form', nxt);
        var classname = "error_ajax";
        if (form.length) {
            $(':input', form).attr('disabled', true);
            form.addClass('disabled');
            classname += "_form";
        }
        if (!$('.' + classname, nxt).length) {
            nxt.append('<div class="' + classname + '">' + data + '</div>');
        } else {
            $('.' + classname, nxt).html(data);
        }
        if (nxt.is(':hidden')) {
            nxt.slideDown();
        }
    }    

    function bind_submit(form, nxt) {
        var post_data = {};

        $("input[type=submit]", form).bind("mousedown", function() {
            post_data = {};
            post_data[this.name] = this.value;
        });

        form.bind("submit", function(e) {
            var data_dict = $(":input", form).serializeArray();
            $.each(data_dict, function() {
                post_data[this.name] = this.value;
            });
            $(":input", form).attr('disabled', 'disabled');
            post_data.is_ajax = 1;
            $.ajax({
                type: 'POST',
                url: form.attr('action'),
                data: post_data,
                dataType: 'html',
                error: function(data, textStatus, xhrobject) {
                    return ajax_error(nxt, data, textStatus);
                },
                success: function(data, textStatus, xhrobject) {
                    if (xhrobject.status == 201 || xhrobject.status == 202) {
                        // we are posting a real comment, not a pre-visualization
                        if (nxt.hasClass('new_comment_form_wrapper')) {
                            var tree = $('#mptt-comments-tree');
                            if (tree.data('reversed')) {
                                tree.prepend(data);
                            } else {
                                tree.append(data);
                            }
                            if (xhrobject.status == 201) {
                                // the comment was created
                                var comment_count = $('#comment_count');
                                var toplevel_comment_count = $('#comment_toplevel_count');

                                nxt.html('<p>' + gettext("Your comment was posted.") + '</p>');
                                comment_count.text(parseInt(comment_count.text(), 10) + 1);
                                if (post_data.parent_pk !== "") {
                                    toplevel_comment_count.text(parseInt(toplevel_comment_count.text(), 10) + 1);
                                }
                            } else {
                                // the comment was posted but is awaiting moderation, we shouldn't update counts etc
                                nxt.html('<p>' + gettext("Your comment was posted, it is now awaiting moderation to be displayed.") + '</p>');
                            }
                        }
                        else {
                            update_replies_count(nxt);
                            nxt.replaceWith(data);
                        }
                    } else {
                        // we are pre-visualizing a comment
                        append_data_and_rebind_form(nxt, data);
                    }
                }
            }); // end ajax call
            e.preventDefault();
        }); // end submit callback
    }

    function load_new_comment_form(url, node) {
        $.ajax({
            type: 'GET',
            url: url,
            dataType: 'html',
            error: function(data, textStatus, xhrobject) {
                return ajax_error(node, data, textStatus);
            },
            success: function(data, textStatus, xhrobject) {
                append_data_and_rebind_form(node, data);
            }
        });
    }

    $('a.comment_reply').live("click", function(e) {
        var parent = $(this).parents('.comment_outer');
        var nxt = parent.next('.comment_form_wrapper');

        if (!parent.length) {
            nxt = $('.new_comment_form_wrapper');
        }
        else if (!nxt.length) {
            nxt = $('<div class="comment_form_wrapper"></div>').insertAfter(parent);
            nxt.hide();
        }
        else {
            nxt.slideUp("slow");
        }
        
        load_new_comment_form($(this).attr('href') + '?is_ajax=1', nxt);
        e.preventDefault();
    });

    $('a.comment_cutoff').live("click", function(e) { 
        var href = $(this).attr('href');
        var id = 'c' + (new RegExp("(\\d+)/$").exec(href)[1]);

        if (!is_in(replies_loaded, id)) {
            $.get($(this).attr('href') + '?is_ajax=1', {}, function(data, textStatus) {
                var comments_tree = data.comments_tree;
                if (comments_tree) {
                    $('#' + id).append(comments_tree.html);
                }
                replies_loaded.push(id);
            }, "json");
        }
        e.preventDefault();
    });

    $('.comment_expand').live("click", function(e) {
        var href = $(this).attr('href');
        var id = 'c' + (new RegExp("(\\d+|preview)/$").exec(href)[1]);
        var comment_el = $('#' + id);

        if (comment_el.hasClass('comment_collapsed')) {
            comment_el.removeClass('comment_collapsed');
            comment_el.addClass('comment_expanded');
        }
        else {
            comment_el.addClass('comment_collapsed');
            comment_el.removeClass('comment_expanded');
        }
        e.preventDefault();
    });

    $('.comments_more').live("click", function(e) {
        $.get($(this).attr('href') + '?is_ajax=1', { }, function(data, textStatus) {
            var comments_for_update = data.comments_for_update;
            var tid = data.tid;
            var more = $('#c' + tid + ' .comments_more');
            var morep = more.parent();
            var comments_tree = data.comments_tree;
            var remaining_count = data.remaining_count;
            var update_len = 0;

            if (comments_for_update) {
                update_len = comments_for_update.length;
                for (var c = 0; c < update_len; c++) {
                    var comment = comments_for_update[c];
                    if ("parent" in comment) {
                        if (comment.parent == tid && morep) {
                            morep.before(comment.html);
                        }
                        else {
                            $('#c' + comment.parent).append(comment.html);
                        }
                    }
                }
            }

            if (comments_tree) {
                $('#mptt-comments-tree').append(comments_tree.html);
            }

            if (remaining_count > 0) {
                var old_href = more.attr('href');
                var last_comment_pk;

                $('#c' + tid + ' .comments_more_remaining').html(remaining_count);
                if (update_len) {
                    last_comment_pk = comments_for_update[update_len - 1].pk;
                }
                else {
                    last_comment_pk = comments_tree.end_pk;
                }

                more.attr('href', old_href.replace(new RegExp("\\d+/$"), last_comment_pk + '/'));
            }
            else {
                morep.hide();
            }

        }, "json");
        e.preventDefault();
    });
    
    function detailCommentFromHash() {
        if (location.hash.length > 0) {
            var r = new RegExp("^#(c\\d+)$").exec(location.hash);
            if (r && r.length) {
                var comment = $('#' + r[1]);
                if (comment.length) {
                    $('.detail_comment').removeClass('detail_comment');
                    comment.addClass('detail_comment');
                }
            }
        }
    }
    
    detailCommentFromHash();
    window.onhashchange = detailCommentFromHash;

    $('.new_comment_form_wrapper').each(function() {
        var nxt = $(this);
        var frm = $('form', nxt);

        bind_submit(frm, nxt);
    });

    $('a.comment_post_new').live("click", function(e) {
        var toplevel_comment_form = $('.new_comment_form_wrapper form');
        // If the new_comment_form_wrapper element does not have a form, 
        // create a new one.
        if (!$('.new_comment_form_wrapper form').length) {
            var comment_form_url = $(this).attr('href');
            var nxt = $('.new_comment_form_wrapper');
            load_new_comment_form(comment_form_url + '?is_ajax=1', nxt);
        }
        
        // Go to new comment form
        window.location.hash = '#post_new_comment';
        e.preventDefault();
    });
});
