(function() {
  var start = new Date().valueOf();
  var cs = {{ categories|safe }};
  var cl = cs.length;
  window.PRODUCTS = {};
  window.PRODUCTS.categories = [];
  window.PRODUCTS.list = [];
  window.PRODUCTS.map = {};
  window.CART = window.CART || {};
  for (var ci=0;ci<cl;ci++) {
    var cjson = cs[ci];
    var img = cjson[2];
    var category = {
      pk: cjson[0],
      name: cjson[1],
      img: {width:img[0],height:img[1],url:img[2]},
    }
    window.PRODUCTS.categories.push(category)
  }
  var ps = {{ products|safe }};
  for (var pi=0,pl=ps.length;pi<pl;pi++) {
    var pj = ps[pi];
    var img = pj[2];
    var price = pj[3]/100;
    var product = {
      pk: pj[0],
      name: pj[1],
      img: {width:img[0],height:img[1],url:img[2]},
      price: (price%1==0)?price:price.toFixed(2),
      quantity: window.CART[pj[0]] || 0,
      categories: pj[4],
      in_stock: pj[5]
    }
    window.PRODUCTS.list.push(product);
    window.PRODUCTS.map[product.pk] = product;
    updateCartButton();
  }
  if (window.PRODUCTS_EXTRA) {
    console.log(1);
    window.PRODUCTS.list.forEach(function(product) {
      var e = window.PRODUCTS_EXTRA[product.pk] || {};
      for (var attr in e) { product[attr] = e[attr]; }
    });
  }
  window.visible_products = PRODUCTS.list;

  //console.log(new Date().valueOf() - start);
})();
